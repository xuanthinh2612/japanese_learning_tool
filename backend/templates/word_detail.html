{% extends "layout.html" %}
{% block title %}{{ word_text }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/grammar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/word.css') }}">
{% endblock %}

{% block content %}

<div class="grammar-detail-wrapper">

    <!-- ===================== -->
    <!-- HEADER (REUSE GRAMMAR) -->
    <!-- ===================== -->
    <div class="grammar-header">
        <div class="main-word">
            {{ word.forms | map(attribute='form') | join('„Éª') }}
        </div>

        {% if word.level %}
        <div class="grammar-level-badge">
            {{ word.level }}
        </div>
        {% endif %}
    </div>

    <!-- ===================== -->
    <!-- READING -->
    <!-- ===================== -->
    {% if word.readings %}
    <div class="grammar-section">
        <h3>üî§ C√°ch ƒë·ªçc</h3>
        <p>
            {{ word.readings | map(attribute='reading') | join('„Éª') }}
        </p>
    </div>
    {% endif %}

    <!-- ===================== -->
    <!-- MEANINGS / SENSES -->
    <!-- ===================== -->
    {% for sense in word.senses %}
    <div class="grammar-section">

        <h3>üìñ Nghƒ©a{% if sense.pos %} ({{ sense.pos }}){% endif %}</h3>

        {% for g in sense.glosses %}
            {% if g.means_vi %}
                <span><i>{{ g.means_vi }}</i>,&nbsp;</span>
            {% endif %}
        {% endfor %}

        {% if sense.examples %}
        <div class="grammar-section">
            <h3>‚úè V√≠ d·ª•</h3>
            <ul class="grammar-examples">
                {% for ex in sense.examples %}
                <li>
                    <b>{{ ex.sentence }}</b>
                    {% if ex.translation_vi %}
                        <p>{{ ex.translation_vi }}</p>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

    </div>
    {% endfor %}

    <!-- ===================== -->
    <!-- ARTICLE CONTEXT -->
    <!-- ===================== -->
    {% if articles %}
    <div class="grammar-section">
        <h3>üì∞ S·ª≠ d·ª•ng trong th·ª±c t·∫ø</h3>

        <ul class="grammar-examples">
            {% for title, source, content, count in articles %}
            <li>
                <b>{{ title }}</b>
                <p>{{ source }} ¬∑ {{ count }} times</p>
                <div>{{ content | safe }}</div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- ===================== -->
    <!-- ACTIONS -->
    <!-- ===================== -->
    <div class="btn-actions">
        <button class="btn primary add-word-btn" 
        onclick="addWordToMyList({{word.id}}, this)" 
        {% if btn_data.disabled_flg %}disabled{% endif %}
         >
            {{btn_data.display_text}}
        </button>
        <button class="btn ghost" onclick="goBack()">‚Üê Quay l·∫°i danh s√°ch</button>
    </div>

</div>

<!-- ===================== -->
<!-- SCRIPT (SAFE) -->
<!-- ===================== -->


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const keyword = "{{ word_text }}";
        if (!keyword) return;

        const regex = new RegExp(`(${keyword})`, "gi");

        document.querySelectorAll(".important-word").forEach(el => {
            if (el.dataset.word.trim() == keyword) {
                el.classList.add('highlight-word');
            }
        });
    });
</script>

<script>
    document.addEventListener("click", async (e) => {
        const popup = document.getElementById("word-popup");

        // click v√†o word
        if (e.target.classList.contains("word")) {
            e.stopPropagation();

            const keyword = e.target.dataset.word;

            try {
                const res = await fetch(`/api/word/${encodeURIComponent(keyword)}`);
                if (!res.ok) return;

                const data = await res.json();

                // ===== render popup =====
                let html = "";

                // Title (kanji)
                html += `<div class="word-popup-title">${data.forms.join("„Éª")}</div>`;

                // Reading
                if (data.readings.length) {
                    html += `<div class="word-popup-reading">${data.readings.join("„Éª")}</div>`;
                }

                // Senses
                let before_pos = "";

                data.senses.forEach((s, idx) => {
                    html += `<div class="word-popup-sense">`;
                    
                    if (s.pos && s.pos != before_pos) {
                        html += `<div class="word-popup-pos">${s.pos}</div>`;
                        before_pos = s.pos;
                    }

                    if (s.meanings.vi?.length) {
                        html += `<div class="word-popup-mean vi">${s.meanings.vi.join("; ")}</div>`;
                    }

                    html += `</div>`;
                });

                popup.innerHTML = html;
                popup.style.left = e.pageX + 10 + "px";
                popup.style.top = e.pageY + 10 + "px";
                popup.style.display = "block";

            } catch (err) {
                console.error(err);
            }

            return;
        }

        // click ngo√†i ‚Üí ·∫©n popup
        popup.style.display = "none";
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("span").forEach(span => {
        const text = span.textContent
            .replace(/\u3000/g, " ")  // ƒë·ªïi space Nh·∫≠t
            .trim();

        // n·∫øu sau khi trim m√† r·ªóng => kh√¥ng c√≥ text th·∫≠t
        if (text === "") {
            span.replaceWith(document.createElement("br"));
        }
    });
});
</script>

<script>
    function addWordToMyList(wordId, btn) {
        fetch(`/add_to_learning/${wordId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        })
        .then(r => r.json())
        .then(res => {
            showToast(res.message);
            if (res.success) {
                btn.disabled = true
                btn.innerHTML = "ƒê√£ th√™m v√†o danh s√°ch"
            }
        });
    }
    
    function showToast(msg){
        const box = document.getElementById("toast-container");
        const t = document.createElement("div");
        t.innerText = msg;
        t.style.cssText = `
            background: linear-gradient(90deg, #3498dbb7, #2ecc7097);
            color: #fff;
            padding: 12px 20px;
            margin-top: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-weight: 500;
            min-width: 180px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        `;
        box.insertBefore(t, box.firstChild);

        setTimeout(()=>{ t.style.opacity = 1; t.style.transform = 'translateY(0)'; }, 10);
        setTimeout(()=>{ t.style.opacity = 0; t.style.transform = 'translateY(20px)'; setTimeout(()=>t.remove(), 300); }, 2500);
    }
</script>
{% endblock %}
